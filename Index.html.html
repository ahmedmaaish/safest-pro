<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<title>SAFEST Pro — OneFile v3.1</title>
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="theme-color" content="#0b5ed7">
<style>
:root{ --bg:#0a0f14; --card:#111820; --text:#e8f1f5; --muted:#86a; --line:#243242; --accent:#0b5ed7; --pad:14px; --radius:12px; }
*{box-sizing:border-box} body{margin:0; background:var(--bg); color:var(--text); font-family:-apple-system,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
.header{position:sticky; top:0; z-index:10; background:linear-gradient(90deg,#0b5ed7,#0a58ca); padding:12px var(--pad)}
.header h1{margin:0; font-size:18px}
.container{max-width:1120px; margin:0 auto; padding:var(--pad)}
.grid{display:grid; gap:var(--pad)} @media(min-width:900px){ .grid-2{grid-template-columns:1.2fr .8fr} }
.card{background:var(--card); border:1px solid var(--line); border-radius:var(--radius); padding:var(--pad)}
h2{margin:0 0 10px; font-size:16px} label{display:block; font-size:12px; color:var(--muted); margin:8px 0 6px}
input[type=number], select, input[type=text]{width:100%; padding:10px 12px; border-radius:10px; border:1px solid #27313c; background:#0e151d; color:#e8f1f5; font-size:16px}
.row{display:grid; gap:var(--pad); grid-template-columns:1fr 1fr}
.metric{font-size:18px; font-weight:700} .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace}
.pill{display:inline-block; padding:4px 8px; border-radius:999px; background:#10273c; color:#bfe0ff; font-size:12px}
.btn{background:var(--accent); border:none; color:#fff; padding:10px 12px; border-radius:10px; font-weight:600; cursor:pointer}
.btn.secondary{background:#223244} .btn.bad{background:#b02a37} .btn.ghost{background:transparent; border:1px solid var(--line); color:#bcd}
.small{font-size:12px; color:#86a} .hr{height:1px; background:var(--line); margin:12px 0}
table{width:100%; border-collapse:collapse; font-size:14px}
th,td{padding:10px 8px; border-bottom:1px solid var(--line); text-align:left; vertical-align:top}
th{color:#b7c7d9; position:sticky; top:0; background:#111820; z-index:1}
.notice{background:#0e1520; border:1px dashed #2a3848; padding:10px 12px; border-radius:10px}
.warn{background:#2a1b1b; border:1px solid #5b2f2f; padding:10px 12px; border-radius:10px; color:#ffdede}
.chips{display:flex; flex-wrap:wrap; gap:6px; margin-top:6px}
.chip{background:#172432; border:1px solid #27445e; padding:6px 10px; border-radius:999px; cursor:pointer; user-select:none}
.inner{background:#0f1620; border:1px solid #233041; border-radius:10px; padding:8px; margin-top:8px}
.inline{display:flex; gap:6px; align-items:center; flex-wrap:wrap}
.inline input{width:90px}
.kbd{background:#121d26; border:1px solid var(--line); border-bottom-color:#1c2b3a; padding:2px 6px; border-radius:6px; font-size:12px}
</style>
</head>
<body>
<div class="header"><h1>SAFEST Pro — OneFile v3.1</h1></div>
<div class="container grid grid-2">
  <section class="card">
    <h2>Dashboard</h2>
    <div id="envWarn" class="warn" style="display:none">Open in <b>Safari/Chrome/Firefox</b> (not Files preview). Data auto-saves on your device.</div>
    <div class="row">
      <div><label>Balance (CENT)</label><input id="balanceCent" type="number" step="1"></div>
      <div>
        <label>Preset</label>
        <select id="preset">
          <option value="GEN">Generic XAUUSD (min 0.01, step 0.01, pip $1)</option>
          <option value="FINER">Finer step (min 0.001, step 0.001, pip $1)</option>
          <option value="CUSTOM">Custom…</option>
        </select>
      </div>
    </div>
    <div class="row">
      <div><label>Base Risk %</label><input id="baseRisk" type="number" step="0.0001"></div>
      <div><label>Default Stop Loss (pips)</label><input id="slPips" type="number" step="1"></div>
    </div>
    <div class="row">
      <div><label>Min Lot</label><input id="minLot" type="number" step="0.001"></div>
      <div><label>Lot Step</label><input id="lotStep" type="number" step="0.001"></div>
    </div>
    <div class="row">
      <div><label>Pip Value per 1.00 lot (USD/pip)</label><input id="pipValue" type="number" step="0.01"></div>
      <div><label>Rounding (lot decimals)</label><input id="dispDec" type="number" min="0" max="4" step="1"></div>
    </div>
    <div class="hr"></div>
    <div class="row">
      <div><label>Soft Drawdown % (risk ×0.5)</label><input id="softDD" type="number" step="0.001"></div>
      <div><label>Hard Drawdown % (risk ×0.25)</label><input id="hardDD" type="number" step="0.001"></div>
    </div>
    <div class="row">
      <div><label>Max Consecutive Losses (STOP)</label><input id="maxConsec" type="number" step="1" min="1"></div>
      <div><label>Daily Max Loss % (STOP for day)</label><input id="dailyMaxLoss" type="number" step="0.001"></div>
    </div>
    <div class="row">
      <div><label>Daily Max Trades</label><input id="dailyMaxTrades" type="number" step="1" min="1"></div>
      <div><label>Cooldown after loss (minutes)</label><input id="cooldownMin" type="number" step="1" min="0"></div>
    </div>
    <div class="hr"></div>
    <div class="small">All changes save automatically. Per-trade SL & partial profits supported.</div>
    <div class="hr"></div>
    <div class="row">
      <button id="addRow" class="btn">Add Trade Row</button>
      <button id="exportJson" class="btn secondary">Export JSON</button>
      <button id="exportCsv" class="btn secondary">Export CSV</button>
      <input id="importFile" type="file" accept=".json,.csv" style="display:none">
      <button id="importBtn" class="btn secondary">Import</button>
      <button id="resetAll" class="btn bad">Reset All</button>
    </div>
  </section>

  <section class="card">
    <h2>Next Trade</h2>
    <div class="row">
      <div><label>Start</label><div id="m_start" class="metric mono">$0.00</div></div>
      <div><label>Adj Risk %</label><div id="m_riskPct" class="metric mono">0.00%</div></div>
      <div><label>Risk ($)</label><div id="m_riskUsd" class="metric mono">$0.00</div></div>
      <div><label>Recommended Lot</label><div id="m_lot" class="metric mono">0.000</div></div>
      <div><label>Trade Allowed?</label><div id="m_allowed" class="metric"><span class="pill">YES</span></div></div>
    </div>
    <div class="hr"></div>
    <div class="notice">
      <div class="small"><b>Why min lot?</b> Need Risk$ ≥ minLot × pipValue × SL.</div>
      <div class="row">
        <div><span class="small">Required Risk$</span><div class="metric mono" id="reqRisk">$0.00</div></div>
        <div><span class="small">Balance needed @ current risk</span><div class="metric mono" id="reqBal">$0.00</div></div>
      </div>
    </div>
  </section>

  <section class="card" style="grid-column:1/-1">
    <h2>Trade Log</h2>
    <div class="small">Per-trade SL is editable. Tap <span class="kbd">Partial</span> to record partial profits with up to 3 legs.</div>
    <div style="overflow-x:auto">
      <table id="log">
        <thead>
          <tr>
            <th>#</th><th>Date</th><th>Start</th><th>Peak</th><th>DD%</th><th>Prev Ls</th>
            <th>Adj%</th><th>Risk$</th><th>SL</th><th>Lot</th>
            <th>Result</th><th>P/L$</th><th>End</th><th>Next Ls</th><th>Actions</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </section>
</div>

<script>
const $=s=>document.querySelector(s);
const key="safest_pro_state_v31";
function envCheck(){ let ok=true; try{ localStorage.setItem("__t","1"); localStorage.removeItem("__t"); }catch(e){ ok=false; } const ua=navigator.userAgent||""; const isQuickLook=ua.includes("QuickLook"); if(!ok||isQuickLook){ const w=document.createElement('div'); w.textContent='Open in Safari/Chrome/Firefox (not Files preview).'; w.style.cssText='background:#2a1b1b;color:#ffdede;border:1px solid #5b2f2f;padding:10px;border-radius:10px;margin:10px 0'; document.querySelector('.container').prepend(w); } }
envCheck();
const presets={ GEN:{minLot:0.01,lotStep:0.01,pipValue:1.0}, FINER:{minLot:0.001,lotStep:0.001,pipValue:1.0} };
const defaults={ balanceCent:2470, preset:"GEN", baseRisk:0.005, slPips:50, minLot:0.01, lotStep:0.01, pipValue:1.0, dispDec:3, softDD:0.05, hardDD:0.10, maxConsec:3, dailyMaxLoss:0.04, dailyMaxTrades:6, cooldownMin:0, trades:[{date:today(),r:null,sl:null,legs:[]},{date:today(),r:null,sl:null,legs:[]},{date:today(),r:null,sl:null,legs:[]}] };
let state=load();
function load(){ try{const s=JSON.parse(localStorage.getItem(key)||"null"); if(!s) return {...defaults}; return {...defaults,...s, trades:Array.isArray(s.trades)? s.trades:[]}; }catch(e){ return {...defaults}; } }
function save(){ try{ localStorage.setItem(key, JSON.stringify(state)); }catch(e){} }
setInterval(save,1500); window.addEventListener("pagehide",save); document.addEventListener("visibilitychange",()=>{ if(document.visibilityState==="hidden") save(); });
function bind(id){ const el=$("#"+id); el.value=state[id]; el.addEventListener("input", e=>{ let v=(id==="preset")? e.target.value : parseFloat(e.target.value); if(id!=="preset" && !Number.isFinite(v)) v=defaults[id]; state[id]=v; if(id==="preset" && v!=="CUSTOM"){ Object.assign(state, presets[v]); $("#minLot").value=state.minLot; $("#lotStep").value=state.lotStep; $("#pipValue").value=state.pipValue; } save(); render(); }); }
["balanceCent","preset","baseRisk","slPips","minLot","lotStep","pipValue","dispDec","softDD","hardDD","maxConsec","dailyMaxLoss","dailyMaxTrades","cooldownMin"].forEach(bind);
$("#addRow").addEventListener("click", ()=>{ state.trades.push({date:today(), r:null, sl:null, legs:[]}); save(); render(); });
$("#resetAll").addEventListener("click", ()=>{ if(confirm("Reset everything?")){ state={...defaults}; save(); render(); } });
$("#importBtn").addEventListener("click", ()=>$("#importFile").click());
$("#importFile").addEventListener("change", importFile);
$("#exportJson").addEventListener("click", exportJson);
$("#exportCsv").addEventListener("click", exportCsv);
function today(){ const d=new Date(); return d.toISOString().slice(0,10); }
function roundStep(x, step){ return Math.round(x/step)*step; }
function f(n,d=2){ return (Number.isFinite(n)?n:0).toFixed(d); }
function weightedR(legs, remainderR){ if(!Array.isArray(legs)||legs.length===0) return remainderR ?? 0; let pctSum=0,total=0; for(const L of legs){ const p=Number(L.pct)||0, R=Number(L.R)||0; pctSum+=Math.max(0,p); total += (Math.max(0,p)/100)*R; } const rem=Math.max(0,1-pctSum/100); return total + rem*(Number(remainderR)||0); }
function compute(){ const rows=[]; const start0=state.balanceCent/100; let peak=start0, prevLs=0, lastEnd=start0; for(let i=0;i<state.trades.length;i++){ const t=state.trades[i]; const row={}; row.idx=i+1; row.date=t.date||today(); row.start=(i===0?start0:lastEnd); peak=Math.max(peak,row.start); row.peak=peak; row.dd=peak<=0?0:(peak-row.start)/peak; const ddF=row.dd>=state.hardDD?0.25:(row.dd>=state.softDD?0.5:1); const lsF=prevLs>=state.maxConsec?0:(prevLs>=state.maxConsec-1?0.5:1); row.adjPct=state.baseRisk*Math.min(ddF,lsF); row.risk=row.start*row.adjPct; row.sl=(t.sl==null||t.sl==="")?state.slPips:Number(t.sl); const raw=(state.pipValue>0 && row.sl>0)? row.risk/(state.pipValue*row.sl):0; row.lot=Math.max(state.minLot, roundStep(raw, state.lotStep)); const usingPartials=Array.isArray(t.legs)&&t.legs.length>0; const rVal=usingPartials ? weightedR(t.legs, t.r) : (t.r==null? null: Number(t.r)); row.r=rVal; row.pl=(rVal==null?0:row.risk*rVal); row.end=row.start+row.pl; row.prevLs=prevLs; row.nextLs=(rVal!=null && rVal<0)? prevLs+1:0; lastEnd=row.end; prevLs=row.nextLs; peak=Math.max(peak,row.end); row.f={start:"$"+f(row.start), peak:"$"+f(row.peak), dd:f(row.dd*100)+"%", adj:f(row.adjPct*100)+"%", risk:"$"+f(row.risk), lot:f(row.lot, state.dispDec), pl:"$"+f(row.pl), end:"$"+f(row.end)}; row.legs=t.legs||[]; row.remainderR=t.r; row.slRaw=t.sl; rows.push(row);} const nextStart=state.trades.length? rows[rows.length-1].end: start0; const nextPeak=Math.max(peak,nextStart); const nextDD=nextPeak<=0?0:(nextPeak-nextStart)/nextPeak; const ddF=nextDD>=state.hardDD?0.25:(nextDD>=state.softDD?0.5:1); const lsF=prevLs>=state.maxConsec?0:(prevLs>=state.maxConsec-1?0.5:1); let nextRiskPct=state.baseRisk*Math.min(ddF,lsF); const nextRisk=nextStart*nextRiskPct; const nextLot=Math.max(state.minLot, roundStep((state.pipValue>0 && state.slPips>0)? nextRisk/(state.pipValue*state.slPips):0, state.lotStep)); const reqRisk=state.minLot*state.pipValue*state.slPips; const reqBal=state.baseRisk>0? reqRisk/state.baseRisk:0; return {rows, next:{start:nextStart, riskPct:nextRiskPct, risk:nextRisk, lot:nextLot, reqRisk, reqBal}}; }
function render(){ const c=compute(); $("#m_start").textContent="$"+f(c.next.start); $("#m_riskPct").textContent=f(c.next.riskPct*100)+"%"; $("#m_riskUsd").textContent="$"+f(c.next.risk); $("#m_lot").textContent=f(c.next.lot, state.dispDec); $("#m_allowed").innerHTML=`<span class="pill">${c.next.riskPct>0?"YES":"NO — STOP"}</span>`; $("#reqRisk").textContent="$"+f(c.next.reqRisk); $("#reqBal").textContent="$"+f(c.next.reqBal); const tb=$("#log tbody"); tb.innerHTML=""; c.rows.forEach((r,i)=>{ const tr=document.createElement("tr"); const td=t=>{const d=document.createElement("td"); d.textContent=t; tr.appendChild(d);}; td(r.idx); const dtd=document.createElement("td"); const dateInput=document.createElement("input"); dateInput.type="text"; dateInput.value=r.date; dateInput.style.width="120px"; dateInput.onchange=e=>{ state.trades[i].date=e.target.value; save(); render(); }; dtd.appendChild(dateInput); tr.appendChild(dtd); td(r.f.start); td(r.f.peak); td(r.f.dd); td(r.prevLs); td(r.f.adj); td(r.f.risk); const sltd=document.createElement("td"); const slInput=document.createElement("input"); slInput.type="number"; slInput.step="1"; slInput.placeholder=String(state.slPips); slInput.value=(r.slRaw==null||r.slRaw==="")?"":r.slRaw; slInput.oninput=e=>{ const v=parseFloat(e.target.value); state.trades[i].sl=Number.isFinite(v)?v:null; save(); render(); }; sltd.appendChild(slInput); tr.appendChild(sltd); td(r.f.lot); const resTd=document.createElement("td"); const quick=["-1","-0.5","0","+1","+1.5","+2"]; const chips=document.createElement("div"); chips.className="chips"; quick.forEach(v=>{ const c=document.createElement("div"); c.className="chip"; c.textContent=v; c.onclick=()=>{ state.trades[i].legs=[]; state.trades[i].r=Number(v.replace("+","")); save(); render(); }; chips.appendChild(c); }); resTd.appendChild(chips); const sel=document.createElement("select"); ["","-2","-1.5","-1","-0.5","0","0.5","1","1.5","2","3"].forEach(v=>{ const o=document.createElement("option"); o.value=v; o.textContent=v; const cur=( (r.legs&&r.legs.length>0) ? "" : (r.remainderR==null? "": String(r.remainderR)) ); if(cur===v) o.selected=true; sel.appendChild(o); }); sel.onchange=e=>{ const val=e.target.value; state.trades[i].legs=[]; state.trades[i].r=(val===""?null:Number(val)); save(); render(); }; resTd.appendChild(sel); const partBtn=document.createElement("button"); partBtn.className="btn ghost"; partBtn.textContent="Partial"; resTd.appendChild(document.createElement("div")).style.height="6px"; resTd.appendChild(partBtn); const inner=document.createElement("div"); inner.className="inner"; inner.style.display="none"; partBtn.onclick=()=>{ inner.style.display=(inner.style.display==="none")?"block":"none"; }; const legs=(state.trades[i].legs=state.trades[i].legs||[]); const legsWrap=document.createElement("div"); legs.forEach((L,idx)=>{ const row=document.createElement("div"); row.className="inline"; const p=document.createElement("input"); p.type="number"; p.step="1"; p.placeholder="%"; p.value=L.pct ?? ""; p.oninput=e=>{ const v=parseFloat(e.target.value); legs[idx].pct=Number.isFinite(v)?v:null; save(); render(); }; const rIn=document.createElement("input"); rIn.type="number"; rIn.step="0.1"; rIn.placeholder="R"; rIn.value=L.R ?? ""; rIn.oninput=e=>{ const v=parseFloat(e.target.value); legs[idx].R=Number.isFinite(v)?v:null; save(); render(); }; const del=document.createElement("button"); del.className="btn bad"; del.textContent="×"; del.onclick=()=>{ legs.splice(idx,1); save(); render(); }; row.appendChild(p); row.appendChild(rIn); row.appendChild(del); legsWrap.appendChild(row); }); inner.appendChild(legsWrap); const addLeg=document.createElement("button"); addLeg.className="btn secondary"; addLeg.textContent="+ Add leg"; addLeg.onclick=()=>{ if(legs.length>=3) return; legs.push({pct:null,R:null}); save(); render(); }; inner.appendChild(addLeg); const remWrap=document.createElement("div"); remWrap.className="inline"; remWrap.style.marginTop="6px"; const remLbl=document.createElement("span"); remLbl.textContent="Remainder R:"; const rem=document.createElement("input"); rem.type="number"; rem.step="0.1"; rem.placeholder="0"; rem.value=(state.trades[i].r==null?"":state.trades[i].r); rem.oninput=e=>{ const v=parseFloat(e.target.value); state.trades[i].r=Number.isFinite(v)?v:null; save(); render(); }; remWrap.appendChild(remLbl); remWrap.appendChild(rem); inner.appendChild(remWrap); const presets=document.createElement("div"); presets.className="chips"; const makePreset=(txt,legsArr,remR)=>{ const c=document.createElement("div"); c.className="chip"; c.textContent=txt; c.onclick=()=>{ state.trades[i].legs=legsArr.map(x=>({pct:x[0],R:x[1]})); state.trades[i].r=remR; save(); render(); }; presets.appendChild(c); }; makePreset("50%@+1R, rest BE", [[50,1]], 0); makePreset("25%@+1R +25%@+1.5R, rest +2R", [[25,1],[25,1.5]], 2); makePreset("Close all +1R", [[100,1]], 0); makePreset("Close all -1R", [[100,-1]], 0); inner.appendChild(presets); const clearBtn=document.createElement("button"); clearBtn.className="btn ghost"; clearBtn.textContent="Clear partials"; clearBtn.onclick=()=>{ state.trades[i].legs=[]; save(); render(); }; inner.appendChild(document.createElement("div")).style.height="6px"; inner.appendChild(clearBtn); resTd.appendChild(inner); tr.appendChild(resTd); const plTd=document.createElement("td"); plTd.textContent=r.f.pl; tr.appendChild(plTd); const endTd=document.createElement("td"); endTd.textContent=r.f.end; tr.appendChild(endTd); const nlTd=document.createElement("td"); nlTd.textContent=r.nextLs; tr.appendChild(nlTd); const atd=document.createElement("td"); const dup=document.createElement("button"); dup.className="btn ghost"; dup.textContent="Duplicate"; dup.onclick=()=>{ state.trades.splice(i+1,0, JSON.parse(JSON.stringify(state.trades[i])) ); save(); render(); }; const del=document.createElement("button"); del.className="btn bad"; del.textContent="Delete"; del.onclick=()=>{ state.trades.splice(i,1); save(); render(); }; atd.appendChild(dup); atd.appendChild(document.createTextNode(" ")); atd.appendChild(del); tr.appendChild(atd); tb.appendChild(tr); }); }
function exportJson(){ const blob=new Blob([JSON.stringify(state,null,2)],{type:"application/json"}); const a=document.createElement("a"); a.href=URL.createObjectURL(blob); a.download="safest_state_v31.json"; a.click(); }
function exportCsv(){ const rows=compute().rows; const header=["idx","date","start","peak","dd%","prevLs","adj%","risk$","sl","lot","resultR","pl$","end","nextLs"]; const csv=[header.join(",")].concat(rows.map(r=>[r.idx,r.date,r.f.start.replace("$",""),r.f.peak.replace("$",""),r.f.dd.replace("%",""),r.prevLs,r.f.adj.replace("%",""),r.f.risk.replace("$",""),(r.slRaw==null?"":r.slRaw),r.f.lot,(r.r==null?"":r.r),r.f.pl.replace("$",""),r.f.end.replace("$",""),r.nextLs].join(","))).join("\n"); const blob=new Blob([csv],{type:"text/csv"}); const a=document.createElement("a"); a.href=URL.createObjectURL(blob); a.download="safest_log_v31.csv"; a.click(); }
function importFile(e){ const f=e.target.files[0]; if(!f) return; const reader=new FileReader(); reader.onload=()=>{ try{ let s; if(f.name.endsWith(".json")) s=JSON.parse(reader.result); else{ const lines=reader.result.split(/\r?\n/).filter(Boolean); const out=[]; for(let i=1;i<lines.length;i++){ const parts=lines[i].split(","); out.push({date:parts[1]||today(), r:parts[10]?Number(parts[10]):null, sl:parts[8]?Number(parts[8]):null, legs:[]}); } s={...state, trades:out}; } state={...defaults,...s, trades:Array.isArray(s.trades)? s.trades:[]}; save(); render(); }catch(err){ alert("Import failed: "+err); } }; reader.readAsText(f); }
render();
</script>
</body>
</html>
